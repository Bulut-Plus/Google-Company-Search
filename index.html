<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firma Ara</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.1.11/dist/vuetify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.1.11/dist/vuetify.min.css" rel="stylesheet">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9_hu6yJ7LXoYc0qIWPizJqkubZk6W3f4&libraries=places"></script>
</head>
<body>
  <div id="app">
    <v-app>
      <v-container>
        <h1 class="mb-4">Web Sitesi Olmayan Firmalar</h1>
        <v-form @submit.prevent="search">
          <v-row class="align-center">
            <v-col cols="3">
              <v-autocomplete
                label="İl Seçiniz"
                v-model="selectedProvince"
                :items="provinces"
                label="İl Seçin"
                item-value="name"
                item-title="name"
                @update:model-value="onProvinceChange"
                required
              ></v-autocomplete>
            </v-col>
            <v-col cols="3">
              <v-autocomplete
                label="İlçe Seçiniz"
                v-model="selectedDistrict"
                :items="districts"
                label="İlçe Seçin"
                item-value="name"
                item-title="name"
                required
              ></v-autocomplete>
            </v-col>
            <v-col cols="3">
              <v-text-field
                v-model="category"
                label="Kategori"
                placeholder="Örn: restoran, mobilya, kozmetik"
                required
              ></v-text-field>
            </v-col>
            <v-col cols="3" class="text-center">
              <v-btn color="primary" type="submit">Ara</v-btn>
            </v-col>
          </v-row>
        </v-form>

        <v-divider class="my-4"></v-divider>

        <div v-if="loading" class="text-center my-4">
          <v-progress-circular indeterminate color="primary"></v-progress-circular>
        </div>

        <div v-if="results.length > 0">
          <v-row justify="center" class="mb-4">
            <v-btn :disabled="currentPage === 0" @click="prevPage" class="mr-4">Önceki</v-btn>
            <v-btn :disabled="!hasMorePages" @click="nextPage" class="mr-4">Sonraki</v-btn>
            <v-btn color="success" @click="downloadExcel">Tüm Verileri Excel'e İndir</v-btn>
          </v-row>
          <v-row>
            <v-col cols="12" md="4" v-for="(result, index) in pagedResults[currentPage]" :key="index">
              <v-card>
                <v-card-title>{{ result.name }}</v-card-title>
                <v-card-text>
                  <strong>Adres:</strong> {{ result.address || "Adres bilgisi yok" }} <br>
                  <strong>Puan:</strong> {{ result.rating || "Puanlanmamış" }} <br>
                  <strong>Konum:</strong> {{ result.location.lat }}, {{ result.location.lng }}
                </v-card-text>
              </v-card>
            </v-col>
          </v-row>
        </div>
      </v-container>
    </v-app>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          provinces: [],
          districts: [],
          selectedProvince: null,
          selectedDistrict: null,
          category: "",
          results: [],
          pagedResults: [],
          currentPage: 0,
          lastLocation: null,
          hasMorePages: false,
          nextPageToken: null,
          loading: false,
        };
      },
      methods: {
        async fetchProvinces() {
          try {
            const response = await fetch("https://turkiyeapi.dev/api/v1/provinces");
            const data = await response.json();
            this.provinces = data.data;
          } catch (error) {
            console.error("İller yüklenirken hata:", error);
            alert("İller yüklenirken bir hata oluştu. Lütfen tekrar deneyin.");
          }
        },
        async onProvinceChange() {
          try {
            await this.fetchDistricts();
          } catch (error) {
            console.error("İlçeler yüklenirken hata:", error);
            alert("İlçeler yüklenirken bir hata oluştu. Lütfen tekrar deneyin.");
          }
        },
        async fetchDistricts() {
          if (!this.selectedProvince) return;

          try {
            const response = await fetch(`https://turkiyeapi.dev/api/v1/provinces?name=${this.selectedProvince}`);
            const data = await response.json();
            this.districts = data.data[0]?.districts || [];
          } catch (error) {
            console.error("İlçeler yüklenirken hata:", error);
            alert("İlçeler yüklenirken bir hata oluştu.");
          }
        },
        async search() {
          if (!this.selectedProvince || !this.selectedDistrict || !this.category) {
            alert("Lütfen tüm seçimleri yapın!");
            return;
          }

          this.loading = true;
          try {
            const location = await this.getCoordinates(`${this.selectedDistrict}, ${this.selectedProvince}`);
            if (!location) {
              alert("Koordinatlar alınamadı!");
              return;
            }

            this.lastLocation = location;
            this.results = [];
            this.pagedResults = [];
            this.currentPage = 0;
            this.hasMorePages = false;
            this.nextPageToken = null;

            await this.fetchAllResults(location.lat, location.lng, this.category);
          } catch (error) {
            console.error("Arama işlemi sırasında hata oluştu:", error);
            alert("Bir hata meydana geldi. Lütfen tekrar deneyin.");
          } finally {
            this.loading = false;
          }
        },
        async getCoordinates(address) {
          try {
            const geocoder = new google.maps.Geocoder();
            return new Promise((resolve, reject) => {
              geocoder.geocode({ address }, (results, status) => {
                if (status === "OK") {
                  const location = results[0].geometry.location;
                  resolve({ lat: location.lat(), lng: location.lng() });
                } else {
                  reject(new Error("Geocoding başarısız: " + status));
                }
              });
            });
          } catch (error) {
            console.error("Koordinatlar alınırken hata:", error);
            throw new Error("Koordinatlar alınamadı.");
          }
        },
        async fetchAllResults(lat, lng, keyword) {
          let token = null;
          this.results = [];

          try {
            do {
              await this.searchPlaces(lat, lng, keyword, token);
              token = this.nextPageToken;

              if (this.results.length >= 100) {
                this.results = this.results.slice(0, 100);
                break;
              }
            } while (token);
          } catch (error) {
            console.error("Sonuçlar alınırken hata oluştu:", error);
          } finally {
            this.paginateResults();
          }
        },
        async searchPlaces(lat, lng, keyword, token = null) {
          const service = new google.maps.places.PlacesService(document.createElement("div"));
          const request = token
            ? { pageToken: token, location: new google.maps.LatLng(lat, lng), radius: 5000, keyword }
            : { location: new google.maps.LatLng(lat, lng), radius: 5000, keyword };

          return new Promise((resolve, reject) => {
            service.nearbySearch(request, async (results, status, pagination) => {
              if (status === google.maps.places.PlacesServiceStatus.OK) {
                try {
                  const detailedResults = [];
                  for (const place of results) {
                    const details = await this.getPlaceDetails(place.place_id);
                    if (details && !details.website) {
                      detailedResults.push({
                        name: place.name,
                        address: place.vicinity,
                        rating: place.rating || "Puanlanmamış",
                        url: place.url,
                        location: {
                          lat: place.geometry.location.lat(),
                          lng: place.geometry.location.lng(),
                        },
                      });
                    }
                  }
                  this.results = this.results.concat(detailedResults);
                  this.nextPageToken = pagination?.hasNextPage ? pagination.nextPageToken : null;
                } catch (error) {
                  console.error("Detaylar alınırken hata:", error);
                }
              } else {
                this.nextPageToken = null;
                reject(new Error("NearbySearch başarısız: " + status));
              }
              resolve();
            });
          });
        },
        async getPlaceDetails(placeId) {
          const service = new google.maps.places.PlacesService(document.createElement("div"));
          return new Promise((resolve, reject) => {
            service.getDetails({ placeId }, (place, status) => {
              if (status === google.maps.places.PlacesServiceStatus.OK) {
                resolve(place);
              } else {
                resolve(null);
              }
            });
          });
        },
        paginateResults() {
          const pageSize = 10;
          this.pagedResults = [];
          for (let i = 0; i < this.results.length; i += pageSize) {
            this.pagedResults.push(this.results.slice(i, i + pageSize));
          }
        },
        nextPage() {
          if (this.currentPage < this.pagedResults.length - 1) {
            this.currentPage++;
          }
        },
        prevPage() {
          if (this.currentPage > 0) {
            this.currentPage--;
          }
        },
        downloadExcel() {
          for (const result of this.results) {
            result.location = `${result.location.lat}, ${result.location.lng}`;
          }
          const worksheet = XLSX.utils.json_to_sheet(this.results);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Sonuçlar");
          XLSX.writeFile(workbook, "Sonuçlar.xlsx");
        },
      },
      mounted() {
        this.fetchProvinces();
      },
    });

    const vuetify = Vuetify.createVuetify();
    app.use(vuetify);
    app.mount("#app");
  </script>
</body>
</html>
